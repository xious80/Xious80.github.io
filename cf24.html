<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Guess the country</title>

  <!-- D3+TopoJSON -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3/dist/topojson-client.min.js"></script>

  <style>
    /* ------------------------------------------
       1) Blockera browser‐zoom på hela sidan
    ------------------------------------------- */
    html, body {
      margin:0; padding:0;
      width:100%; height:100%;
      overflow:hidden;
      font-family:sans-serif;
      touch-action: none;
      overscroll-behavior: none;
    }

    /* ------------------------------------------
       2) Quiz‐container (UI får eget touch)
    ------------------------------------------- */
    .quiz-container {
      position:absolute;
      top:10px; right:10px;
      z-index:10;
      touch-action:auto;
    }

    /* ------------------------------------------
       3) Flag‐column: default desktop
    ------------------------------------------- */
    .flag-column {
      display:flex;
      flex-direction:column;
      align-items:center;
      width:160px;        /* desktop‐bredd */
      gap:6px;
    }

    /* ------------------------------------------
       4) UI under flagga
    ------------------------------------------- */
    #ui {
      width:100%;
      background:rgba(255,255,255,0.9);
      padding:4px 6px;
      border-radius:4px;
    }
    #guessInput {
      width:100%;
      padding:6px;
      font:14px sans-serif;
      /* slå av stavningsförslag */
      autocomplete: off;
      autocorrect: off;
      autocapitalize: none;
      spellcheck: false;
      inputmode: text;
    }
    #score {
      width:100%; margin-top:6px;
      font:14px sans-serif; text-align:center;
    }

    /* ------------------------------------------
       5) Mini‐flagga
    ------------------------------------------- */
    #miniFlag {
      width:100%;
      aspect-ratio: 4 / 3;
      border:1px solid #888;
      cursor:pointer;
      transition:box-shadow .3s;
      background:#fff;
    }
    #miniFlag.correct   { box-shadow:0 0 0 4px limegreen; }
    #miniFlag.incorrect { box-shadow:0 0 0 4px crimson; }

    /* ------------------------------------------
       6) Text under flagga/UI
    ------------------------------------------- */
    #correctName {
      width:100%; text-align:center;
      font:14px sans-serif; color:crimson;
      overflow:hidden; white-space:nowrap;
      text-overflow:ellipsis;
    }

    /* ------------------------------------------
       7) SVG/karta – D3 hanterar pinch & drag
    ------------------------------------------- */
    svg {
      position:absolute;
      top:0; left:0;
      width:100vw; height:100vh;
      cursor:move;
      touch-action:none;
      overscroll-behavior:none;
    }
    .country { fill:#e0e0e0; stroke:#aaa; }
    .focus   { fill:url(#flagPattern); stroke:#444; }

    /* ------------------------------------------
       8) Mobile‐portrait: responsiv bredd 25vw,
          och fäst portrait‐layout
    ------------------------------------------- */
    @media (orientation: portrait) {
      /* försök låsa orientation (Chrome+Android) */
      @supports (screen-orientation: portrait) {
        html { screen-orientation: portrait; }
      }
      .flag-column {
        width: 25vw;
        max-width: 200px;
      }
      #ui, #correctName {
        font-size: 1.1em;
      }
    }
  </style>
</head>
<body>

  <!-- DEBUG‐panel -->
  <!-- <div id="debug">» Init…</div> -->

  <div class="quiz-container">
    <div class="flag-column">
      <img id="miniFlag" src="" alt="Mini-flagga"/>
      <div id="ui">
        <input id="guessInput" list="guessList"
               placeholder="Guess country…" autocomplete="off"/>
        <datalist id="guessList"></datalist>
        <div id="score">0/0 (Streak: 0)</div>
      </div>
      <div id="correctName"></div>
    </div>
  </div>

  <svg></svg>

  <script>
  // Kort logger
  function log(...m) {
    const d = document.getElementById("debug");
    if (d) d.textContent += "\n» " + m.join(" ");
  }

  const svg     = d3.select("svg");
  const W       = window.innerWidth;
  const H       = window.innerHeight;
  const inputEl = document.getElementById("guessInput");
  const listEl  = document.getElementById("guessList");
  const scoreEl = document.getElementById("score");
  const flagEl  = document.getElementById("miniFlag");
  const msgEl   = document.getElementById("correctName");

  // geografisk projektion
  const proj = d3.geoMercator().scale(150).translate([W/2, H/2]);
  const path = d3.geoPath(proj);
  const mapG = svg.append("g");

  // defs/pattern för flaggfyllning
  const defs    = svg.append("defs");
  const pattern = defs.append("pattern")
    .attr("id","flagPattern")
    .attr("patternUnits","objectBoundingBox")
    .attr("patternContentUnits","objectBoundingBox")
    .attr("width",1).attr("height",1);
  const patImg = pattern.append("image")
    .attr("x",0).attr("y",0)
    .attr("width",1).attr("height",1)
    .attr("preserveAspectRatio","xMidYMid slice")
    .attr("crossorigin","anonymous");

  // zoom‐inställningar [0.5–8], enda på SVG
  const MIN_Z = 0.5, MAX_Z = 8;
  const zoom = d3.zoom()
    .filter(e => !e.target.closest('.quiz-container'))
    .scaleExtent([MIN_Z, MAX_Z])
    .on("zoom", e => mapG.attr("transform", e.transform));
  svg.call(zoom);

  let features, focus;
  let score=0, attempts=0, streak=0, bestStreak=0;

  // Data‐URLer
  const topoURL  = "https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json";
  const codesURL = "https://flagcdn.com/en/codes.json";

  Promise.all([ d3.json(topoURL), d3.json(codesURL) ])
  .then(([topo, codes]) => {
    // build EnglishName→ISO₂
    const nameToISO = Object.entries(codes)
      .reduce((m,[iso,name]) => (m[name]=iso, m), {});

    // alias för “vita fläckar”
    nameToISO["United States of America"] = nameToISO["United States"];
    nameToISO["Dem. Rep. Congo"]          = nameToISO["Republic of the Congo"];
    nameToISO["S. Sudan"]                 = nameToISO["South Sudan"];
    nameToISO["Central African Rep."]     = nameToISO["Central African Republic"];
    nameToISO["Congo"]                    = nameToISO["DR Congo"];
    nameToISO["Eq. Guinea"]               = nameToISO["Equatorial Guinea"];
    nameToISO["Côte d'Ivoire"]            = nameToISO["Côte d’Ivoire (Ivory Coast)"];
    nameToISO["W. Sahara"]                = nameToISO["Western Sahara"];
    nameToISO["Bosnia and Herz."]         = nameToISO["Bosnia and Herzegovina"];
    nameToISO["Macedonia"]                = nameToISO["North Macedonia"];

    // bygg features‐array
    features = topojson.feature(topo, topo.objects.countries).features
      .filter(f => nameToISO[f.properties.name])
      .map(f => ({
        ...f,
        iso2:   nameToISO[f.properties.name],
        nameEN: f.properties.name
      }));

    // autocomplete
    features.map(f => f.nameEN).sort().forEach(n => {
      const o = document.createElement("option");
      o.value = n;
      listEl.appendChild(o);
    });

    // rita bas‐karta
    mapG.selectAll("path")
      .data(features)
      .join("path")
        .attr("d", path)
        .attr("class", "country");

    // gissnings‐logik
    flagEl.addEventListener("click", () => {
      const guess = inputEl.value.trim().toLowerCase();
      const ok    = focus.nameEN.toLowerCase() === guess;
      attempts++;
      if (ok) {
        score++; streak++; bestStreak = Math.max(bestStreak, streak);
        flash("correct");
        msgEl.textContent = "";
      } else {
        streak = 0;
        flash("incorrect");
        msgEl.textContent = focus.nameEN;
      }
      updateScore();
      inputEl.disabled = true;
      flagEl.style.pointerEvents = "none";
      setTimeout(startNew, 4000);
    });

    startNew();
  })
  .catch(err => log("❌ FEL vid inläsning:", err));

  function updateScore() {
    scoreEl.textContent = `${score}/${attempts} (Streak: ${bestStreak})`;
  }
  function flash(cls) {
    flagEl.classList.add(cls);
    setTimeout(()=>flagEl.classList.remove(cls),500);
  }

  function startNew(){
    msgEl.textContent = "";
    focus = features[Math.floor(Math.random()*features.length)];

    // uppdatera flagga/pattern
    const url = `https://flagcdn.com/w320/${focus.iso2}.png`;
    patImg.attr("href", url);
    flagEl.src = url;

    // markera fokus
    mapG.selectAll("path")
      .attr("class", d => d===focus ? "focus":"country");

    // räkna ut ny transform – centrera på övre halvan (H/4)
    const b  = path.bounds(focus),
          dx = b[1][0]-b[0][0],
          dy = b[1][1]-b[0][1],
          cx = (b[0][0]+b[1][0])/2,
          cy = (b[0][1]+b[1][1])/2,
          maxS = Math.min(W/dx, H/dy) * 0.8;
    let s = maxS * 0.5;
    s = Math.min(s, MAX_Z);   // bara clampa övre
    const t = [ W/2 - s*cx,
                H/4 - s*cy ]; // ändrat till H/4 för Y

    svg.transition().duration(4000)
      .call(zoom.transform,
        d3.zoomIdentity.translate(t[0],t[1]).scale(s)
      );

    // återställ UI
    inputEl.value = "";
    inputEl.disabled = false;
    flagEl.style.pointerEvents = "auto";
    inputEl.focus();
  }

  // stoppa desktop‐zoom
  window.addEventListener('wheel', e=>{
    if (e.ctrlKey||e.metaKey) e.preventDefault();
  }, {passive:false});
  window.addEventListener('keydown', e=>{
    if ((e.ctrlKey||e.metaKey) &&
        ['+','-','=','_','0'].includes(e.key)) {
      e.preventDefault();
    }
  });
  </script>
</body>
</html>
