<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <title>Gissa landet – fungerande CDN-version</title>
  <!-- UMD‐byggen som registrerar globalt topojson och d3 -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3/dist/topojson-client.min.js"></script>
  <style>
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      overflow: hidden;
      font-family: sans-serif;
    }
    svg {
      display: block;
      width: 100vw; height: 100vh;
      cursor: move;
    }
    .country { fill: #e0e0e0; stroke: #aaa; }
    .focus   { fill: url(#flagPattern); stroke: #444; }
    text     { font: 16px sans-serif; fill: #333; pointer-events: none; }
    #ui {
      position: absolute; top:20px; left:20px;
      background: rgba(255,255,255,0.9);
      padding: 8px 12px; border-radius: 6px;
      z-index: 10;
    }
    #guessInput {
      width: 200px;
      padding: 6px 8px;
      font: 14px sans-serif;
    }
    #score {
      margin-top: 6px;
      font: 14px sans-serif;
    }
    #miniFlag {
      position: absolute; top:20px; right:20px;
      width: 160px; height: 120px;
      border: 1px solid #888; cursor: pointer;
      transition: box-shadow .3s ease;
      z-index: 10;
    }
    #miniFlag.correct { box-shadow: 0 0 0 4px limegreen; }
    #miniFlag.incorrect { box-shadow: 0 0 0 4px crimson; }
  </style>
</head>
<body>

  <!-- UI i HTML -->
  <div id="ui">
    <input id="guessInput" list="guessList" placeholder="Gissa landet..." autocomplete="off" />
    <datalist id="guessList"></datalist>
    <div id="score">0/0 (Streak: 0)</div>
  </div>

  <!-- Klickbar mini-flagga -->
  <img id="miniFlag" src="" alt="Mini-flagga" />

  <!-- SVG-kartan -->
  <svg></svg>

  <script>
  // SVG & projection
  const svg    = d3.select("svg");
  const W      = window.innerWidth;
  const H      = window.innerHeight;
  const proj   = d3.geoMercator().scale(150).translate([W/2, H/2]);
  const path   = d3.geoPath(proj);
  const mapG   = svg.append("g");

  // defs + pattern för flaggfyllning
  const defs   = svg.append("defs");
  const pattern = defs.append("pattern")
    .attr("id", "flagPattern")
    .attr("patternUnits", "objectBoundingBox")
    .attr("patternContentUnits", "objectBoundingBox")
    .attr("width",1).attr("height",1);
  const patImg = pattern.append("image")
    .attr("x", 0).attr("y", 0)
    .attr("width", 1).attr("height", 1)
    .attr("preserveAspectRatio", "xMidYMid slice")
    .attr("crossorigin", "anonymous");

  // zoom-behavior
  const zoom = d3.zoom()
    .scaleExtent([1, 8])
    .on("zoom", e => mapG.attr("transform", e.transform));
  svg.call(zoom);

  // DOM-referenser
  const inputEl  = document.getElementById("guessInput");
  const listEl   = document.getElementById("guessList");
  const scoreEl  = document.getElementById("score");
  const miniFlag = document.getElementById("miniFlag");

  // Score-state
  let features, focus;
  let score = 0, attempts = 0, streak = 0, bestStreak = 0;

  // Ladda data
  Promise.all([
    // Använd jsDelivr för world-atlas
    d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json"),
    d3.json("https://flagcdn.com/en/codes.json")
  ]).then(([topo, codes]) => {
    // Bygg upp namn–kod mappning
    const nameToISO = Object.fromEntries(Object.entries(codes));
    const dnSV      = new Intl.DisplayNames(['sv'], {type:'region'});
    const dnEN      = new Intl.DisplayNames(['en'], {type:'region'});

    // Extrahera features och utöka med namn
    features = topojson.feature(topo, topo.objects.countries).features
      .filter(f => nameToISO[f.properties.name])
      .map(f => {
        const iso2 = nameToISO[f.properties.name];
        return Object.assign(f, {
          iso2,
          nameSV: dnSV.of(iso2.toUpperCase()),
          nameEN: dnEN.of(iso2.toUpperCase())
        });
      });

    // Autocomplete–lista
    const names = new Set();
    features.forEach(f => {
      names.add(f.nameSV);
      names.add(f.nameEN);
    });
    Array.from(names).sort().forEach(n => {
      const opt = document.createElement("option");
      opt.value = n;
      listEl.appendChild(opt);
    });

    // Rita bas-karta
    mapG.selectAll("path")
      .data(features)
      .join("path")
        .attr("d", path)
        .attr("class", "country");

    // Klickhantering
    miniFlag.addEventListener("click", () => {
      const guess = inputEl.value.trim().toLowerCase();
      const ok    = [focus.nameSV, focus.nameEN]
                     .some(n => n.toLowerCase() === guess);
      attempts++;
      if (ok) {
        score++; streak++; bestStreak = Math.max(bestStreak, streak);
        flash("correct");
      } else {
        streak = 0;
        flash("incorrect");
      }
      updateScore();
      inputEl.disabled = true;
      miniFlag.style.pointerEvents = "none";
      setTimeout(startNew, 4000);
    });

    // Starta första uppgiften
    startNew();
  });

  function updateScore() {
    scoreEl.textContent = `${score}/${attempts} (Streak: ${bestStreak})`;
  }

  function flash(cls) {
    miniFlag.classList.add(cls);
    setTimeout(() => miniFlag.classList.remove(cls), 500);
  }

  function startNew() {
    // välj nytt land i fokus
    focus = features[Math.floor(Math.random()*features.length)];
    const url = `https://flagcdn.com/w320/${focus.iso2}.png`;

    // uppdatera pattern + mini-flagga
    patImg.attr("href", url);
    miniFlag.src = url;

    // färga kartan
    mapG.selectAll("path")
      .attr("class", d => d===focus ? "focus" : "country");

    // zooma in över 4s
    const [[x0,y0],[x1,y1]] = path.bounds(focus);
    const dx = x1-x0, dy = y1-y0;
    const cx = (x0+x1)/2, cy = (y0+y1)/2;
    const maxS = Math.min(W/dx, H/dy)*0.8;
    const s    = maxS*0.5;
    const t    = [W/2 - s*cx, H/2 - s*cy];

    svg.transition().duration(4000)
      .call(zoom.transform,
        d3.zoomIdentity.translate(t[0],t[1]).scale(s)
      );

    // återställ UI
    inputEl.value = "";
    inputEl.disabled = false;
    inputEl.focus();
    miniFlag.style.pointerEvents = "auto";
  }
  </script>

</body>
</html>
